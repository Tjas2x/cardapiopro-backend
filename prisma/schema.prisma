generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MERCHANT
  CUSTOMER
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  name     String
  role     Role    @default(MERCHANT)
  active   Boolean @default(true)

  // relations
  restaurants Restaurant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Restaurant {
  id          String  @id @default(uuid())
  name        String
  description String?
  phone       String?
  address     String?
  isOpen      Boolean @default(true)

  // FK (owner)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // relations
  products Product[]
  orders   Order[] // ✅ ADICIONADO (opposite relation)

  // ✅ NOVO (assinatura do restaurante)
  subscription Subscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  priceCents  Int
  imageUrl    String?
  active      Boolean @default(true)

  // FK (restaurant)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  orderItems OrderItem[] // ✅ ADICIONADO (opposite relation)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
}

enum OrderStatus {
  NEW
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELED
}

model Order {
  id     String      @id @default(uuid())
  status OrderStatus @default(NEW)

  customerName    String?
  customerPhone   String?
  deliveryAddress String?

  totalCents Int

  // FK (restaurant)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
}

model OrderItem {
  id String @id @default(uuid())

  // FK (order)
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // FK (product)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int

  // snapshot do produto no momento do pedido
  unitPriceCents Int
  nameSnapshot   String

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

//
// ✅ NOVOS (Assinatura / Trial)
//
enum PlanStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELED
}

model Subscription {
  id           String     @id @default(uuid())
  restaurantId String     @unique
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  status      PlanStatus @default(TRIAL)
  trialEndsAt DateTime?
  paidUntil   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([trialEndsAt])
  @@index([paidUntil])
}
