generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  
}

enum Role {
  ADMIN
  MERCHANT
  CUSTOMER
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  name     String
  role     Role    @default(MERCHANT)
  active   Boolean @default(true)

  // relations
  restaurants         Restaurant[]
  activationCodesUsed ActivationCode[] @relation("ActivationCodeUsedBy")
  passwordResetTokens PasswordResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Restaurant {
  id          String  @id @default(uuid())
  name        String
  description String?
  phone       String?
  address     String?
  isOpen      Boolean @default(true)

  // FK (owner)
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // relations
  products Product[]
  orders   Order[]

  // assinatura do restaurante
  subscription Subscription?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  priceCents  Int
  imageUrl    String?
  active      Boolean @default(true)

  // FK (restaurant)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
}

enum OrderStatus {
  NEW
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELED
}

/**
 * ✅ NOVO: Pagamento do pedido (cliente escolhe no cardápio)
 */
enum PaymentMethod {
  PIX
  CARD_CREDIT
  CARD_DEBIT
  CASH
}

model Order {
  id     String      @id @default(uuid())
  status OrderStatus @default(NEW)

  customerName    String?
  customerPhone   String?
  deliveryAddress String?

  totalCents Int

  // ✅ PAGAMENTO
  paymentMethod      PaymentMethod @default(PIX)
  cashChangeForCents Int?
  paid               Boolean       @default(false)

  // FK (restaurant)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([restaurantId])
  @@index([status])
  @@index([paymentMethod])
}

model OrderItem {
  id String @id @default(uuid())

  // FK (order)
  orderId String
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // FK (product)
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int

  // snapshot do produto no momento do pedido
  unitPriceCents Int
  nameSnapshot   String

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

enum PlanStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELED
}

model Subscription {
  id           String     @id @default(uuid())
  restaurantId String     @unique
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  status      PlanStatus @default(TRIAL)
  trialEndsAt DateTime?
  paidUntil   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([trialEndsAt])
  @@index([paidUntil])
}

enum ActivationCodePlan {
  monthly
  yearly
}

model ActivationCode {
  id   String @id @default(uuid())
  code String @unique

  plan ActivationCodePlan
  days Int

  usedAt   DateTime?
  usedById String?
  usedBy   User? @relation("ActivationCodeUsedBy", fields: [usedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([plan])
  @@index([usedAt])
  @@index([usedById])
}
model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}
